# Create a shared workspace for us to pass data from step to step
workspace:
  base: /app
  path: src/github.com/josebarn/drone-python-tutorial

pipeline:
  build:
    # Start with a small image
    image: python:2.7-alpine
    commands:
      # Add some extra support for postgres
      - apk add --update python python-dev py-pip build-base postgresql-dev
      - pip install virtualenv
      # make a virtual eng for installing out binary
      - virtualenv /app/env
      - rm -rf /var/cache/apk/*
      - /app/env/bin/pip install -r requirements.txt
      - /app/env/bin/pip install --upgrade pip setuptools wheel
      - /app/env/bin/pip wheel -r requirements.txt --wheel-dir=wheeldir --find-links=wheeldir
      - /app/env/bin/pip wheel -r test-requirements.txt --wheel-dir=wheeldir --find-links=wheeldir
      - /app/env/bin/pip install --use-wheel --no-index --find-links=wheeldir -r requirements.txt
      - /app/env/bin/pip install --use-wheel --no-index --find-links=wheeldir -r test-requirements.txt
      # package and install
      - /app/env/bin/python setup.py bdist
      - /app/env/bin/python setup.py install

  functional-test:
    image: python:2.7-alpine
    commands:
      # Restore extras for container, the were lost...
      # specifically need libpq.so.5: needed by /app/env/lib/python2.7/site-packages/psycopg2/_psycopg.so
      - apk add --update python python-dev py-pip build-base postgresql-dev
      # Give Postgres DB a moment to startup
      # - sleep 5
      - /app/env/bin/nosetests -v service/test/functional/tests.py
    environment:
        - DEBUG=True
        - SECRET_KEY=asdklfjeoja039rjdlkjfaoi3rdk
        - DATABASE_URL=postgres://username:password@database/test

services:
  database:
    image: postgres:9.6.4-alpine
    environment:
        - POSTGRES_USER=username
        - POSTGRES_PASSWORD=password
        - POSTGRES_DB=test

  redis:
    image: redis:alpine
